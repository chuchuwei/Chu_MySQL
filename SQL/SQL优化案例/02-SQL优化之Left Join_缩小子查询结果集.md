# 慢SQL优化

[toc]

## 慢SQL语句

```shell
SELECT 0 AS PROC_INST_ID_, BURM.USERNAME, 0 AS TASK_ID_, '' AS ASSIGNEE_, btxmas.LASTMODDATE AS START_TIME_
	, btxmas.LASTMODDATE AS END_TIME_, '' AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM VBTXMASM btxmas
	LEFT JOIN (
		SELECT TXNO, MAX(ACCEPTOPINION) AS ACCEPTOPINION
		FROM VLOAAPLE
		GROUP BY TXNO
		UNION ALL
		SELECT TXNO, MAX(ACCEPTOPINION) AS ACCEPTOPINION
		FROM VLOAMASE
		GROUP BY TXNO
	) mase ON mase.TXNO = btxmas.TXNO
	LEFT JOIN VSECBURM BURM ON BURM.USERID = btxmas.LASTMODUSER
	LEFT JOIN (SELECT MIN(ROLEID) AS ROLEID, USERID
		FROM VSECBTRM
		GROUP BY USERID
		) BTRM ON BTRM.USERID = BURM.USERID
	LEFT JOIN VSECROLM ROLM ON ROLM.ROLEID = BTRM.ROLEID
WHERE btxmas.txno = '817648'
UNION ALL
SELECT T.PROC_INST_ID_, BURM.USERNAME, T.ID_ AS TASK_ID_, T.ASSIGNEE_, T.START_TIME_
	, T.END_TIME_, NVL(N.MESSAGE_, '') AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM ST_ACT_HI_TASKINST T
	LEFT JOIN (SELECT PROC_INST_ID_, TASK_ID_, MIN(ID_) AS MIN_COMMENT_ID_, MAX(ID_) AS MAX_COMMENT_ID_
		FROM ST_ACT_HI_COMMENT
		GROUP BY PROC_INST_ID_, TASK_ID_
		) A ON A.PROC_INST_ID_ = T.PROC_INST_ID_
		AND A.TASK_ID_ = T.ID_
	LEFT JOIN ST_ACT_HI_COMMENT M ON M.PROC_INST_ID_ = T.PROC_INST_ID_
		AND M.TASK_ID_ = T.ID_
		AND M.ID_ = A.MIN_COMMENT_ID_
	LEFT JOIN ST_ACT_HI_COMMENT N ON N.PROC_INST_ID_ = T.PROC_INST_ID_
		AND N.TASK_ID_ = T.ID_
		AND N.ID_ = A.MAX_COMMENT_ID_
	LEFT JOIN VSECBURM BURM ON BURM.USERID = T.ASSIGNEE_
	LEFT JOIN (SELECT ROLEID, USERID
		FROM VSECBTRM
		) BTRM ON BTRM.USERID = BURM.USERID
	LEFT JOIN VSECROLM ROLM ON ROLM.ROLEID = BTRM.ROLEID
	LEFT JOIN ST_ACT_HI_IDENTITYLINK inde ON ROLM.ROLEDESC = inde.GROUP_ID_
WHERE m.MESSAGE_ IS NOT NULL
	AND m.MESSAGE_ = '同意'
	AND inde.TASK_ID_ = T.ID_
	AND T.PROC_INST_ID_ = (
		SELECT DISTINCT entityid
		FROM VBTXMASM
		WHERE txno = '817648'
		)
ORDER BY TASK_ID_ ASC

耗时：1857ms
```

![](D:/DBA%E5%AE%A2%E6%88%B7%E6%9C%8D%E5%8A%A1%E6%B1%87%E6%80%BB/MSP-%E5%AE%9D%E5%87%AF%E9%81%93%E8%9E%8D%20RDS%20CPU%E9%A3%99%E9%AB%98v.18.08.29/SQL%E4%BC%98%E5%8C%96/pic/05.png)

1 分析该语句结构可知：上下两个sql语句使用union all连接

2 上下两个SQL语句结构都是left join 多表连接，且left join 的表 包含子查询的结果集

大致结构了解清楚后，可将union 的两个语句进行逐步优化

### 拆分后的慢SQL

```shell
1
SELECT T.PROC_INST_ID_, BURM.USERNAME, T.ID_ AS TASK_ID_, T.ASSIGNEE_, T.START_TIME_
	, T.END_TIME_, NVL(N.MESSAGE_, '') AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM ST_ACT_HI_TASKINST T
	LEFT JOIN (SELECT PROC_INST_ID_, TASK_ID_, MIN(ID_) AS MIN_COMMENT_ID_, MAX(ID_) AS MAX_COMMENT_ID_
		FROM ST_ACT_HI_COMMENT
		GROUP BY PROC_INST_ID_, TASK_ID_
		) A ON A.PROC_INST_ID_ = T.PROC_INST_ID_
		AND A.TASK_ID_ = T.ID_
	LEFT JOIN ST_ACT_HI_COMMENT M ON M.PROC_INST_ID_ = T.PROC_INST_ID_
		AND M.TASK_ID_ = T.ID_
		AND M.ID_ = A.MIN_COMMENT_ID_
	LEFT JOIN ST_ACT_HI_COMMENT N ON N.PROC_INST_ID_ = T.PROC_INST_ID_
		AND N.TASK_ID_ = T.ID_
		AND N.ID_ = A.MAX_COMMENT_ID_
	LEFT JOIN VSECBURM BURM ON BURM.USERID = T.ASSIGNEE_
	LEFT JOIN (SELECT ROLEID, USERID
		FROM VSECBTRM
		) BTRM ON BTRM.USERID = BURM.USERID
	LEFT JOIN VSECROLM ROLM ON ROLM.ROLEID = BTRM.ROLEID
	LEFT JOIN ST_ACT_HI_IDENTITYLINK inde ON ROLM.ROLEDESC = inde.GROUP_ID_
WHERE m.MESSAGE_ IS NOT NULL
	AND m.MESSAGE_ = '同意'
	AND inde.TASK_ID_ = T.ID_
	AND T.PROC_INST_ID_ = (
		SELECT DISTINCT entityid
		FROM VBTXMASM
		WHERE txno = '817648'
		)
ORDER BY TASK_ID_ ASC
耗时：1110 ms.

2
SELECT 0 AS PROC_INST_ID_, BURM.USERNAME, 0 AS TASK_ID_, '' AS ASSIGNEE_, btxmas.LASTMODDATE AS START_TIME_
	, btxmas.LASTMODDATE AS END_TIME_, '' AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM VBTXMASM btxmas
	LEFT JOIN (
		SELECT TXNO, MAX(ACCEPTOPINION) AS ACCEPTOPINION
		FROM VLOAAPLE
		GROUP BY TXNO
		UNION ALL
		SELECT TXNO, MAX(ACCEPTOPINION) AS ACCEPTOPINION
		FROM VLOAMASE
		GROUP BY TXNO
	) mase ON mase.TXNO = btxmas.TXNO
	LEFT JOIN VSECBURM BURM ON BURM.USERID = btxmas.LASTMODUSER
	LEFT JOIN (SELECT MIN(ROLEID) AS ROLEID, USERID
		FROM VSECBTRM
		GROUP BY USERID
		) BTRM ON BTRM.USERID = BURM.USERID
	LEFT JOIN VSECROLM ROLM ON ROLM.ROLEID = BTRM.ROLEID
WHERE btxmas.txno = '817648'

耗时：784ms

3
SELECT 0 AS PROC_INST_ID_, BURM.USERNAME, 0 AS TASK_ID_, '' AS ASSIGNEE_, btxmas.LASTMODDATE AS START_TIME_
	, btxmas.LASTMODDATE AS END_TIME_, '' AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM VBTXMASM btxmas
	LEFT JOIN (
		SELECT TXNO, MAX(ACCEPTOPINION) AS ACCEPTOPINION
		FROM VLOAAPLE
		GROUP BY TXNO
		UNION ALL
		SELECT TXNO, MAX(ACCEPTOPINION) AS ACCEPTOPINION
		FROM VLOAMASE
		GROUP BY TXNO
	) mase ON mase.TXNO = btxmas.TXNO
	LEFT JOIN VSECBURM BURM ON BURM.USERID = btxmas.LASTMODUSER
	LEFT JOIN (SELECT MIN(ROLEID) AS ROLEID, USERID
		FROM VSECBTRM
		GROUP BY USERID
		) BTRM ON BTRM.USERID = BURM.USERID
	LEFT JOIN VSECROLM ROLM ON ROLM.ROLEID = BTRM.ROLEID
WHERE btxmas.txno = '817648'
UNION ALL
SELECT T.PROC_INST_ID_, BURM.USERNAME, T.ID_ AS TASK_ID_, T.ASSIGNEE_, T.START_TIME_
	, T.END_TIME_, NVL(N.MESSAGE_, '') AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM ST_ACT_HI_TASKINST T
	LEFT JOIN (SELECT PROC_INST_ID_, TASK_ID_, MIN(ID_) AS MIN_COMMENT_ID_, MAX(ID_) AS MAX_COMMENT_ID_
		FROM ST_ACT_HI_COMMENT
		GROUP BY PROC_INST_ID_, TASK_ID_
		) A ON A.PROC_INST_ID_ = T.PROC_INST_ID_
		AND A.TASK_ID_ = T.ID_
	LEFT JOIN ST_ACT_HI_COMMENT M ON M.PROC_INST_ID_ = T.PROC_INST_ID_
		AND M.TASK_ID_ = T.ID_
		AND M.ID_ = A.MIN_COMMENT_ID_
	LEFT JOIN ST_ACT_HI_COMMENT N ON N.PROC_INST_ID_ = T.PROC_INST_ID_
		AND N.TASK_ID_ = T.ID_
		AND N.ID_ = A.MAX_COMMENT_ID_
	LEFT JOIN VSECBURM BURM ON BURM.USERID = T.ASSIGNEE_
	LEFT JOIN (SELECT ROLEID, USERID
		FROM VSECBTRM
		) BTRM ON BTRM.USERID = BURM.USERID
	LEFT JOIN VSECROLM ROLM ON ROLM.ROLEID = BTRM.ROLEID
	LEFT JOIN ST_ACT_HI_IDENTITYLINK inde ON ROLM.ROLEDESC = inde.GROUP_ID_
WHERE m.MESSAGE_ IS NOT NULL
	AND m.MESSAGE_ = '同意'
	AND inde.TASK_ID_ = T.ID_
	AND T.PROC_INST_ID_ = (
		SELECT DISTINCT entityid
		FROM VBTXMASM
		WHERE txno = '817648'
		)
ORDER BY TASK_ID_ ASC

耗时：1857ms

```

### 优化步骤

#### 一般优化思路

1 查看执行计划

2 检查索引，看被驱动表的字段是否含有索引、复合索引等

3 若索引无法进一步优化则考虑改写SQL，保证最后结果一致

#### 查看执行计划

![](D:/DBA%E5%AE%A2%E6%88%B7%E6%9C%8D%E5%8A%A1%E6%B1%87%E6%80%BB/MSP-%E5%AE%9D%E5%87%AF%E9%81%93%E8%9E%8D%20RDS%20CPU%E9%A3%99%E9%AB%98v.18.08.29/SQL%E4%BC%98%E5%8C%96/pic/04.png)

索引经查看后无法进一步优化，且执行几乎中可以看到 **ST_ACT_HI_COMMENT**表扫描行数最多，则可以从这里为切入点进行优化

```shell
SELECT T.PROC_INST_ID_, BURM.USERNAME, T.ID_ AS TASK_ID_, T.ASSIGNEE_, T.START_TIME_
	, T.END_TIME_, NVL(N.MESSAGE_, '') AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM ST_ACT_HI_TASKINST T
	LEFT JOIN (SELECT PROC_INST_ID_, TASK_ID_, MIN(ID_) AS MIN_COMMENT_ID_, MAX(ID_) AS MAX_COMMENT_ID_
		FROM ST_ACT_HI_COMMENT
		GROUP BY PROC_INST_ID_, TASK_ID_
		) A ON A.PROC_INST_ID_ = T.PROC_INST_ID_
		AND A.TASK_ID_ = T.ID_

耗时 898ms
```

首先，单独执行该SQL语句，时间占比为总时间的80%，可以确定问题原因

将此SQL中有关的条件同时加上一起分析,where条件中有和驱动表相关的条件，如下：

```shell
改写前：
SELECT T.PROC_INST_ID_, BURM.USERNAME, T.ID_ AS TASK_ID_, T.ASSIGNEE_, T.START_TIME_
	, T.END_TIME_, NVL(N.MESSAGE_, '') AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM ST_ACT_HI_TASKINST T
	LEFT JOIN (SELECT PROC_INST_ID_, TASK_ID_, MIN(ID_) AS MIN_COMMENT_ID_, MAX(ID_) AS MAX_COMMENT_ID_
		FROM ST_ACT_HI_COMMENT
		GROUP BY PROC_INST_ID_, TASK_ID_
		) A ON A.PROC_INST_ID_ = T.PROC_INST_ID_
		AND A.TASK_ID_ = T.ID_
WHERE T.PROC_INST_ID_ = (
		SELECT DISTINCT entityid
		FROM VBTXMASM
		WHERE txno = '817648'
		)
		
# 分析此语句的逻辑
1 首先根据条件PROC_INST_ID_取出t表的数据（假设有一行数据）
2 根据PROC_INST_ID_列和TASK_ID_列和子查询的结果集（有几千行）进行连接，分别扫描几千行和t表的一行进行匹配
# 分析：
t表的PROC_INST_ID_结果已经知道，A表在和t表通过PROC_INST_ID_进行连接的时候，即已经知道了A表的所以PROC_INST_ID_列的值。所以可以在子查询中指定PROC_INST_ID_列的值。
# 改写后逻辑
1 首先根据条件PROC_INST_ID_取出t表的数据（假设有一行数据）
2 子查询中给定PROC_INST_ID_列的值（1行数据），和t表进行连接，此时只扫描一行数据

改写后：
SELECT T.PROC_INST_ID_, BURM.USERNAME, T.ID_ AS TASK_ID_, T.ASSIGNEE_, T.START_TIME_
	, T.END_TIME_, NVL(N.MESSAGE_, '') AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM ST_ACT_HI_TASKINST T
	LEFT JOIN (SELECT PROC_INST_ID_,MIN(ID_) AS MIN_COMMENT_ID_, MAX(ID_) AS MAX_COMMENT_ID_
		FROM ST_ACT_HI_COMMENT where PROC_INST_ID_ = (SELECT DISTINCT entityid
		FROM VBTXMASM
		WHERE txno = '817648'
		)) A ON A.PROC_INST_ID_ = T.PROC_INST_ID_
WHERE T.PROC_INST_ID_ = (
		SELECT DISTINCT entityid
		FROM VBTXMASM
		WHERE txno = '817648'
		)
		
# 为什么连接后的条件A.TASK_ID_ = T.ID_ 取消了
左连接，以表为准，此条件的结果影响的是右表的数据，而最终查询的结果中不包含A表的信息，只有t表的信息，所以可以取消
```

第二部分SQL同理

#### 优化

需要缩小子查询的结果集来优化此SQL

```shell
1
SELECT T.PROC_INST_ID_, BURM.USERNAME, T.ID_ AS TASK_ID_, T.ASSIGNEE_, T.START_TIME_
	, T.END_TIME_, NVL(N.MESSAGE_, '') AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM ST_ACT_HI_TASKINST T
	LEFT JOIN (SELECT PROC_INST_ID_,MIN(ID_) AS MIN_COMMENT_ID_, MAX(ID_) AS MAX_COMMENT_ID_
		FROM ST_ACT_HI_COMMENT where PROC_INST_ID_ = (SELECT DISTINCT entityid
		FROM VBTXMASM
		WHERE txno = '817648'
		)) A ON A.PROC_INST_ID_ = T.PROC_INST_ID_
	LEFT JOIN ST_ACT_HI_COMMENT M ON M.PROC_INST_ID_ = T.PROC_INST_ID_
		AND M.TASK_ID_ = T.ID_
		AND M.ID_ = A.MIN_COMMENT_ID_
	LEFT JOIN ST_ACT_HI_COMMENT N ON N.PROC_INST_ID_ = T.PROC_INST_ID_
		AND N.TASK_ID_ = T.ID_
		AND N.ID_ = A.MAX_COMMENT_ID_
	LEFT JOIN VSECBURM BURM ON BURM.USERID = T.ASSIGNEE_
	LEFT JOIN (SELECT ROLEID, USERID
		FROM VSECBTRM
		) BTRM ON BTRM.USERID = BURM.USERID
	LEFT JOIN VSECROLM ROLM ON ROLM.ROLEID = BTRM.ROLEID
	LEFT JOIN ST_ACT_HI_IDENTITYLINK inde ON ROLM.ROLEDESC = inde.GROUP_ID_
WHERE m.MESSAGE_ IS NOT NULL
	AND m.MESSAGE_ = '同意'
	AND inde.TASK_ID_ = T.ID_
	AND T.PROC_INST_ID_ = (
		SELECT DISTINCT entityid
		FROM VBTXMASM
		WHERE txno = '817648'
		)
ORDER BY TASK_ID_ ASC
耗时：5ms

2

SELECT 0 AS PROC_INST_ID_, BURM.USERNAME, 0 AS TASK_ID_, '' AS ASSIGNEE_, btxmas.LASTMODDATE AS START_TIME_
	, btxmas.LASTMODDATE AS END_TIME_, '' AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM VBTXMASM btxmas
	LEFT JOIN (
		SELECT TXNO, MAX(ACCEPTOPINION) AS ACCEPTOPINION
		FROM VLOAMASE where TXNO='817648'
	) mase ON mase.TXNO = btxmas.TXNO
	LEFT JOIN VSECBURM BURM ON BURM.USERID = btxmas.LASTMODUSER
	LEFT JOIN (SELECT MIN(ROLEID) AS ROLEID, USERID
		FROM VSECBTRM
		GROUP BY USERID
		) BTRM ON BTRM.USERID = BURM.USERID
	LEFT JOIN VSECROLM ROLM ON ROLM.ROLEID = BTRM.ROLEID
WHERE btxmas.txno = '817648'
耗时：5ms

3
SELECT 0 AS PROC_INST_ID_, BURM.USERNAME, 0 AS TASK_ID_, '' AS ASSIGNEE_, btxmas.LASTMODDATE AS START_TIME_
	, btxmas.LASTMODDATE AS END_TIME_, '' AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM VBTXMASM btxmas
	LEFT JOIN (
		SELECT TXNO, MAX(ACCEPTOPINION) AS ACCEPTOPINION
		FROM VLOAMASE where TXNO='817648'
	) mase ON mase.TXNO = btxmas.TXNO
	LEFT JOIN VSECBURM BURM ON BURM.USERID = btxmas.LASTMODUSER
	LEFT JOIN (SELECT MIN(ROLEID) AS ROLEID, USERID
		FROM VSECBTRM
		GROUP BY USERID
		) BTRM ON BTRM.USERID = BURM.USERID
	LEFT JOIN VSECROLM ROLM ON ROLM.ROLEID = BTRM.ROLEID
WHERE btxmas.txno = '817648'
UNION ALL
SELECT T.PROC_INST_ID_, BURM.USERNAME, T.ID_ AS TASK_ID_, T.ASSIGNEE_, T.START_TIME_
	, T.END_TIME_, NVL(N.MESSAGE_, '') AS MESSAGE_, ROLM.ROLEDESC AS MEMO_
FROM ST_ACT_HI_TASKINST T
	LEFT JOIN (SELECT PROC_INST_ID_,MIN(ID_) AS MIN_COMMENT_ID_, MAX(ID_) AS MAX_COMMENT_ID_
		FROM ST_ACT_HI_COMMENT where PROC_INST_ID_ = (SELECT DISTINCT entityid
		FROM VBTXMASM
		WHERE txno = '817648'
		)) A ON A.PROC_INST_ID_ = T.PROC_INST_ID_
	LEFT JOIN ST_ACT_HI_COMMENT M ON M.PROC_INST_ID_ = T.PROC_INST_ID_
		AND M.TASK_ID_ = T.ID_
		AND M.ID_ = A.MIN_COMMENT_ID_
	LEFT JOIN ST_ACT_HI_COMMENT N ON N.PROC_INST_ID_ = T.PROC_INST_ID_
		AND N.TASK_ID_ = T.ID_
		AND N.ID_ = A.MAX_COMMENT_ID_
	LEFT JOIN VSECBURM BURM ON BURM.USERID = T.ASSIGNEE_
	LEFT JOIN (SELECT ROLEID, USERID
		FROM VSECBTRM
		) BTRM ON BTRM.USERID = BURM.USERID
	LEFT JOIN VSECROLM ROLM ON ROLM.ROLEID = BTRM.ROLEID
	LEFT JOIN ST_ACT_HI_IDENTITYLINK inde ON ROLM.ROLEDESC = inde.GROUP_ID_
WHERE m.MESSAGE_ IS NOT NULL
	AND m.MESSAGE_ = '同意'
	AND inde.TASK_ID_ = T.ID_
	AND T.PROC_INST_ID_ = (
		SELECT DISTINCT entityid
		FROM VBTXMASM
		WHERE txno = '817648'
		)
ORDER BY TASK_ID_ ASC
耗时：7ms
```

![](D:/DBA%E5%AE%A2%E6%88%B7%E6%9C%8D%E5%8A%A1%E6%B1%87%E6%80%BB/MSP-%E5%AE%9D%E5%87%AF%E9%81%93%E8%9E%8D%20RDS%20CPU%E9%A3%99%E9%AB%98v.18.08.29/SQL%E4%BC%98%E5%8C%96/pic/05.png)

## 优化后结果对比

| 序号        | 优化前 | 优化后 | 备注                  |
| ----------- | ------ | ------ | --------------------- |
| 1           | 1110ms | 5ms    | SQL改写（缩小结果集） |
| 2           | 784ms  | 5ms    | SQL改写（缩小结果集） |
| 完整SQL语句 | 1857ms | 7ms    | SQL改写（缩小结果集） |





